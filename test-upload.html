<!DOCTYPE html>
<html>
<head>
    <title>Excel Upload Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
        }
        .section {
            border: 1px solid #ccc;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background: #45a049;
        }
        #result {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 4px;
            margin-top: 20px;
            white-space: pre-wrap;
            font-family: monospace;
            max-height: 400px;
            overflow: auto;
        }
        .success { color: green; }
        .error { color: red; }
    </style>
</head>
<body>
    <h1>üß™ Excel Upload Debugger</h1>
    
    <div class="section">
        <h2>Step 1: Test File Upload</h2>
        <p>This will test if the file can be uploaded and parsed</p>
        <input type="file" id="testFile" accept=".xlsx,.xls,.csv">
        <button onclick="testUpload()">Test Upload</button>
    </div>
    
    <div class="section">
        <h2>Step 2: Actual Upload</h2>
        <p>This will attempt the full upload process</p>
        <input type="file" id="actualFile" accept=".xlsx,.xls,.csv">
        <select id="mode">
            <option value="replace">Replace</option>
            <option value="update">Update</option>
        </select>
        <button onclick="actualUpload()">Upload for Real</button>
    </div>
    
    <div id="result"></div>
    
    <div class="section">
        <h2>üìã Server Logs (Live)</h2>
        <button onclick="refreshLogs()">Refresh Logs</button>
        <button onclick="clearLogs()">Clear Logs</button>
        <div id="serverLogs" style="background: #f5f5f5; padding: 15px; margin-top: 10px; max-height: 300px; overflow: auto; font-family: monospace; font-size: 12px;"></div>
    </div>
    
    <script>
        function log(message, type = 'info') {
            const result = document.getElementById('result');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : '';
            result.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            result.scrollTop = result.scrollHeight;
        }
        
        async function testUpload() {
            const fileInput = document.getElementById('testFile');
            const file = fileInput.files[0];
            
            if (!file) {
                log('‚ùå Please select a file', 'error');
                return;
            }
            
            log(`üìÅ Testing file: ${file.name} (${file.size} bytes)`);
            
            try {
                const formData = new FormData();
                formData.append('file', file);
                
                log('üì§ Sending to test endpoint...');
                const response = await fetch('http://localhost:3010/api/test-upload', {
                    method: 'POST',
                    body: formData
                });
                
                log(`üì® Response status: ${response.status}`);
                const data = await response.json();
                
                if (response.ok) {
                    log('‚úÖ SUCCESS!', 'success');
                    log('Response data:', 'success');
                    log(JSON.stringify(data, null, 2), 'success');
                } else {
                    log('‚ùå ERROR', 'error');
                    log(JSON.stringify(data, null, 2), 'error');
                }
            } catch (error) {
                log('‚ùå EXCEPTION: ' + error.message, 'error');
                console.error(error);
            }
        }
        
        async function actualUpload() {
            const fileInput = document.getElementById('actualFile');
            const file = fileInput.files[0];
            const mode = document.getElementById('mode').value;
            
            if (!file) {
                log('‚ùå Please select a file', 'error');
                return;
            }
            
            log(`üìÅ Uploading file: ${file.name} in ${mode} mode`);
            
            try {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('mode', mode);
                
                log('üì§ Sending to upload endpoint...');
                const response = await fetch('http://localhost:3010/api/upload-excel', {
                    method: 'POST',
                    body: formData
                });
                
                log(`üì® Response status: ${response.status}`);
                const data = await response.json();
                
                if (response.ok) {
                    log('‚úÖ SUCCESS!', 'success');
                    log(`Added: ${data.apartmentsAdded} apartments`, 'success');
                    log(`Total: ${data.totalApartments} apartments`, 'success');
                    log('Full response:', 'success');
                    log(JSON.stringify(data, null, 2), 'success');
                } else {
                    log('‚ùå ERROR', 'error');
                    log(JSON.stringify(data, null, 2), 'error');
                }
            } catch (error) {
                log('‚ùå EXCEPTION: ' + error.message, 'error');
                console.error(error);
            }
        }
        
        async function refreshLogs() {
            try {
                const response = await fetch('http://localhost:3010/api/logs');
                const data = await response.json();
                const logsDiv = document.getElementById('serverLogs');
                
                if (data.logs && data.logs.length > 0) {
                    logsDiv.innerHTML = data.logs.map(log => {
                        const time = new Date(log.time).toLocaleTimeString();
                        const color = log.type === 'error' ? 'red' : 'black';
                        return `<div style="color: ${color}">[${time}] ${log.message}</div>`;
                    }).join('');
                    logsDiv.scrollTop = logsDiv.scrollHeight;
                } else {
                    logsDiv.innerHTML = '<div style="color: gray">No logs yet</div>';
                }
            } catch (error) {
                document.getElementById('serverLogs').innerHTML = 
                    '<div style="color: red">Failed to fetch logs: ' + error.message + '</div>';
            }
        }
        
        async function clearLogs() {
            try {
                await fetch('http://localhost:3010/api/logs/clear', { method: 'POST' });
                document.getElementById('serverLogs').innerHTML = '<div style="color: gray">Logs cleared</div>';
                log('üóëÔ∏è Server logs cleared');
            } catch (error) {
                log('‚ùå Failed to clear logs: ' + error.message, 'error');
            }
        }
        
        // Auto-refresh logs every 2 seconds
        setInterval(refreshLogs, 2000);
        
        log('üöÄ Test page loaded. Server should be running on http://localhost:3010');
        log('üí° Server logs will auto-refresh every 2 seconds');
        
        // Initial log fetch
        refreshLogs();
    </script>
</body>
</html>

